name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v5
        with:
          java-version: "21"
          distribution: "corretto"

      - uses: ./.github/actions/cache-gradle
        with:
          cache-key-prefix: gradle

      - run: chmod +x gradlew

      # 1. GitHub Release 먼저 생성 (release notes 자동 생성)
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: true

      # 2. Release body 가져와서 plugin.xml에 주입
      - name: Update plugin.xml change-notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Release body 가져오기 (markdown → HTML 변환)
          RELEASE_BODY=$(gh api repos/${{ github.repository }}/releases/${{ steps.create_release.outputs.id }} --jq '.body')

          # Markdown을 HTML로 변환
          RELEASE_HTML=$(echo "$RELEASE_BODY" | sed \
            -e 's/^## \(.*\)$/<h2>\1<\/h2>/g' \
            -e 's/^### \(.*\)$/<h3>\1<\/h3>/g' \
            -e 's/^\* \(.*\)$/<li>\1<\/li>/g' \
            -e 's/^- \(.*\)$/<li>\1<\/li>/g' | grep -v '^$' | tr '\n' ' ')

          # plugin.xml의 change-notes 업데이트 (multiline 처리)
          perl -i -0777 -pe "s|<change-notes>.*?</change-notes>|<change-notes><![CDATA[$RELEASE_HTML]]></change-notes>|s" \
            src/main/resources/META-INF/plugin.xml

      # 3. 빌드 및 퍼블리시
      - run: ./gradlew build

      - run: ./gradlew buildPlugin

      - run: ./gradlew publishPlugin
        env:
          INTELLIJ_PUBLISH_TOKEN: ${{ secrets.INTELLIJ_PUBLISH_TOKEN }}

      # 4. Release를 publish하고 zip 파일 업로드
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          files: build/distributions/*.zip
